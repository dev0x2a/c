#include <stdint.h>
#include <time.h>
#include <tommath.h>
#include <unistd.h>

uint64_t _tt;
#ifdef IOWNANATHLON
#include <unistd.h>
#define SLEEP sleep(4)
#else
#define SLEEP
#endif

#ifdef LTM_TIMING_REAL_RAND
#define LTM_TIMING_RAND_SEED time(NULL)
#else
#define LTM_TIMING_RAND_SEED 23
#endif

void ndraw(mp_int *a, char *name)
{
  char buf[4096];
  printf("%s: ", name);
  mp_toradix(a, buf, 64);
  printf("%s\n", buf);
}

static void draw(mp_int *a)
{ ndraw(a, ""); }

unsigned long lfsr = 0xAAAAAAAAUL;
int lbit(void)
{
  if (lfsr & 0x80000000UL) {
    lfsr = ((lfsr << 1) ^ 0x8000001BUL) & 0xFFFFFFFFUL;
    return 1;
  } else {
    lfsr <<= 1;
    return 0;
  }
}

/* RDTSC from Scott Duplichan */
static uint64_t TIMFUNC(void)
{
#if defined __GNUC__
#if defined(__i386__) || defined(__x86_64__)
  /* version from http://www.mcs.anl.gov/~kazutomo/rdtsc.html
   * the old code always got a warning issued by gcc, clang did not
   * complain... */
  unsigned hi, lo;
  __asm__ __volatile__("rdtsc" : "=a"(lo), "=d"(hi));
  return ((uint64_t)lo) | (((uint64_t)hi) << 32);
#else /* gcc-IA64 version */
  unsigned long result;
  __asm__ __volatile__("mov %0=ar.itc" : "=r"(result)::"memory");

  while (__builtin_expect((int)result == -1, 0))
    __asm__ __volatile__("mov %0=ar.itc" : "=r"(result)::"memory");
  return result;
#endif
// Microsoft and Intel Windows compilers
#elif defined _M_IX86
  __asm rdtsc
#elif defined _M_AMD64
  return __rdtsc();
#elif defined _M_IA64
#if defined __INTEL_COMPILER
#include <ia64intrin.h>
#endif
  return __getReg(3116);
#else
#error need rdtsc function for this build
#endif
}

#define DO(x) \
  x; \
  x;
//#define DO4(x) DO2(x); DO2(x);
//#define DO8(x) DO4(x); DO4(x);
//#define DO(x)  DO8(x); DO8(x);

#ifdef TIMING_NO_LOGS
#define FOPEN(a,b) NULL
#define FPRINTF(a,b,c,d)
#define FFLUSH(a)
#define FCLOSE(a) (void)(a)
#else
#define FOPEN(a,b) fopen(a,b)
#define FPRINTF(a,b,c,d) fprintf(a,b,c,d)
#define FFLUSH(a) fflush(a)
#define FCLOSE(a) fclose(a)
#endif

int main(void)
{
  uint64_t tt, gg, CLK_PER_SEC;
  FILE *log, *logb, *logc, *logd;
  mp_int a, b, c, d, e, f;
  int n, cnt, ix, old_kara_m, old_kara_s, old_toom_m, old_toom_s;
  unsigned rr;

  mp_init(&a);
  mp_init(&b);
  mp_init(&c);
  mp_init(&d);
  mp_init(&e);
  mp_init(&f);

  srand(LTM_TIMING_RAND_SEED);
  CLK_PER_SEC = TIMFUNC();
  sleep(1);
  CLK_PER_SEC = TIMFUNC()-CLK_PER_SEC;

  printf("CLK_PER_SEC == %llu\n", CLK_PER_SEC);
  log = FOPEN("logs/add.log", "w");
  for (cnt=8; cnt<=128; cnt+=8) {
    SLEEP;
    mp_rand(&a, cnt);
    mp_rand(&b, cnt);
    rr = 0;
    tt = -1;
    do {
      gg = TIMFUNC();
      DO(mp_add(&a, &b, &c));
      gg = (TIMFUNC()-gg) >> 1;
      if (tt > gg)
        tt = gg;
    } while (++rr < 100000);
    printf("Adding\t\t%4d-bit => %9llu/sec, %9llu cycles\n",
           mp_count_bits(&a), CLK_PER_SEC/tt, tt);
    FPRINTF(log, "%d %9llu\n", cnt*DIGIT_BIT, tt);
    FFLUSH(log);
  }
  FCLOSE(log);

  log = FOPEN("logs/sub.log", "w");
  for (cnt=8; cnt<=128; cnt+=8) {
    SLEEP;
    mp_rand(&a, cnt);
    mp_rand(&b, cnt);
    rr = 0;
    tt = -1;
    do {
      gg = TIMFUNC();
      DO(mp_sub(&a, &b, &c));
      gg = (TIMFUNC()-gg) >> 1;
      if (tt > gg)
        tt = gg;
    } while (++rr < 100000);
    printf("Subtracting\t\t%4d-bit => %9llu/sec, %9llu cycles\n",
           mp_count_bits(&a), CLK_PER_SEC / tt, tt);
    FPRINTF(log, "%d %9llu\n", cnt * DIGIT_BIT, tt);
    FFLUSH(log);
  }
  FCLOSE(log);

  /* do mult/square twice, first without karatsuba and second with */
  old_kara_m = KARATSUBA_MUL_CUTOFF;
  old_kara_s = KARATSUBA_SQR_CUTOFF;
  /* currently toom-cook cut-off is too high to kick in, so we just use the
   * karatsuba values */
  old_toom_m = old_kara_m;
  old_toom_s = old_kara_m;
  for (ix=0; ix<3; ++ix) {
    printf("With%s Karatsuba, With%s Toom\n", (ix == 0) ? "out" : "",
           (ix == 1) ? "out" : "");
    KARATSUBA_MUL_CUTOFF = (ix == 1) ? old_kara_m : 9999;
    KARATSUBA_SQR_CUTOFF = (ix == 1) ? old_kara_s : 9999;
    TOOM_MUL_CUTOFF = (ix == 2) ? old_toom_m : 9999;
    TOOM_SQR_CUTOFF = (ix == 2) ? old_toom_s : 9999;
    log = FOPEN((ix == 0)
                  ? "logs/mult.log"
                  : (ix == 1) ? "logs/mult_kara.log" : "logs/mult_toom.log",
                "w");
    for (cnt=4; cnt<=10240/DIGIT_BIT; cnt+=2) {
      SLEEP;
      mp_rand(&a, cnt);
      mp_rand(&b, cnt);
      rr = 0;
      tt = -1;
      do {
        gg = TIMFUNC();
        DO(mp_mul(&a, &b, &c));
        gg = (TIMFUNC()-gg) >> 1;
        if (tt > gg)
          tt = gg;
      } while (++rr < 100);
      printf("Multiplying\t%4d-bit => %9llu/sec, %9llu cycles\n",
             mp_count_bits(&a), CLK_PER_SEC / tt, tt);
      FPRINTF(log, "%d %9llu\n", mp_count_bits(&a), tt);
      FFLUSH(log);
    }
    FCLOSE(log);
    log = FOPEN((ix == 0)
                  ? "logs/sqr.log"
                  : (ix == 1) ? "logs/sqr_kara.log" : "logs/sqr_toom.log",
                "w");
    for (cnt=4; cnt<=10240/DIGIT_BIT; cnt+=2) {
      SLEEP;
      mp_rand(&a, cnt);
      rr = 0;
      tt = -1;
      do {
        gg = TIMFUNC();
        DO(mp_sqr(&a, &b));
        gg = (TIMFUNC()-gg) >> 1;
        if (tt > gg)
          tt = gg;
      } while (++rr < 100);
      printf("Squaring\t%4d-bit => %9llu/sec, %9llu cycles\n",
             mp_count_bits(&a), CLK_PER_SEC/tt, tt);
      FPRINTF(log, "%d %9llu\n", mp_count_bits(&a), tt);
      FFLUSH(log);
    }
    FCLOSE(log);
  }
  {
    char *primes[] = { /* 2K large moduli */
      "17976931348623159077293051907890247336179769789423065727343008115773"
      "26758055009631327084773224075360211201138798713933576587897688144166"
      "22492847430639474124377767893424865485276302219601246094119453082952"
      "08500576883815068234246288147391311054082723716335051068458623933410"
      "0047359817950870678242457666208137217",
      "32317006071311007300714876688669951960444102669715484032130345427524"
      "65513886789089319720141152291346368871796092189801949411955915049092"
      "10950881523864482831206308773673009960917501977503896521067960576383"
      "84067568276792218642619756161838094338476170470581645852036305042887"
      "57589154106580860755239912393038552191433338966834242068497478656456"
      "94948561760353263220580778056593310261927084603141502585928641771167"
      "25943603718461857357598351152301645904403697613233287231227125684710"
      "82020972515710172693132346967854258065669793504599726835299863809973"
      "30771521211401200311504245416967919510975295468014290276688699274917"
      "25169",
      "10443888814131525066917527107166243825799642490473837803842334832839"
      "53907971557456848826811934997558340890106714439262837987573438185793"
      "60726323608785136527794595697654370999834036159013438371831442807001"
      "18559462263763188393977127456723346843445866174968079087058037040712"
      "84048740118609114467977783598029006686938976881787785946905630190260"
      "94059957945343282346930302669644305902501597239986771421554169383555"
      "98852914863182379144344967340878118726394964751001890413490084170616"
      "75093668333850551032972088269550769983616369411933015213796825837188"
      "09183365675122131849284636812555022599830041234478486259567449219461"
      "70238065059132456108257318353800876086221028342701976982023131690176"
      "78006675195485079921636419370285375124784014907159135459982790513399"
      "61155179427110683113409058427288427979155484978295432353451706522326"
      "90613949059876930021229633956877828789484406160074129456749198230505"
      "71642377154816321380631045902916136926708342856440730447899971901781"
      "46576347322385026725305989979599609079946920177462481771844986745565"
      "92501783290704731194331655508075682218465717463732968849128195203174"
      "57002440926616910874148385078411929804522981857338977648103126085902"
      "99520825742185524979672172903974411816593843369482332569664209689212"
      "4547425283", /* 2K moduli mersenne primes */
      "68647976601306097149819007990813932172694353001433054093944634591855"
      "43183397656052122559640661454554977296311391480858037121987999716643"
      "812574028291115057151",
      "53113799281676709868958820655246862732959311772703192319944413820040"
      "35598608522427391625022652292856688893294862465010153465793376527072"
      "39409519978766587351943831270835393219031728127",
      "10407932194664399081925240327364085538615262247266704805319112350403"
      "60805967336029801223944173232418484242161395428100779138356624832346"
      "49081399066056773207629241295093892203457731833496615835504729594205"
      "47689811211693677147548478866962501384438260291732348885311160828538"
      "41658502825560466622483189091880184706822220314052102669843548873295"
      "8028878050869736186900714720710555703168729087",
      "14759799152141802350848986227373817363120661453331697751477712164785"
      "70297878078949377407337049389289382748507531496480477281264838760259"
      "19181446336533026954049696120111343015690239609398909022625932693502"
      "52814096149834993882228314485986018343185362309237726413902094902318"
      "36446899608210795482963763094236630945410832793769905399982457186322"
      "94472963641889062337217172374210563644036821845964963294853869690587"
      "26504869144346374575072804418236768135178520993486608471725794084223"
      "16678097670224011990280170474894487426924742108823536808485072502240"
      "51945258754287534997655857267022963396257521263747789778550155264652"
      "2609988869914013540483809865681250419497686697771007",
      "25911708601320262777624676792244153094181888755312542730397492316187"
      "40192665863620862012095168004834065506952417331941774416895092388070"
      "17410377709597512042313066624082916353517952311186154862265604547691"
      "12759584877561056875793119101771140882625215384903583040118507211642"
      "47474618230314713983402292880745456779079410372882358207058923510684"
      "33882986888616658650280927692080339605869308790500409503709875902119"
      "01837199162099400256893511313654882973911265679730324198651725011641"
      "27035097054277734779723498216764434466683831193225400996489940517902"
      "41624056519054483690809616061625743042361721863339415852426431208737"
      "26659196206175353574889289459962919518308262186085340093793283942026"
      "18665861425032514507730962742353768229386494071277008460771242118230"
      "80804139298087057504713825264571448379371125032081826126566649084251"
      "69945395188778961365024840573937859459944433523118828012366040626246"
      "86092121503499375847822922371443396288584859382157388212323936870461"
      "60677362909315071",
      "19079700752443907380746804296952917366935699474994017739474188267352"
      "89797870050537063680498355149002443034959549507097257621863112241488"
      "28811920216904542206960744666169364221195289538436845390250168663932"
      "83880519205513715439091266652753300730929268753909225704336251785736"
      "66246999754023754629544902932592333031373306435315565397399219262014"
      "38606439020075174723029056838272505051571967594608350063404495977660"
      "65626902082396082556701234418990892795664601199805798854863010763738"
      "09935198265823897818881357054086530452196558017580812511640805546090"
      "57468028203308718724654081055323215860189611391296030471108443146745"
      "67196776630892585854727150731156376517100831824864711009761489031356"
      "28565417841548817431460339096027379473850553559603318556145409000814"
      "56378659068370317267696980001187750995491090350108417050917991562167"
      "97228107016130597251804487204833130638371509485493841573854989460607"
      "07225847379781766864221343545269894430283536440371873753853978382595"
      "11833166416134323695660367676897722287918773420968982326089026150031"
      "51542416546211133752743115489066632737492144627683356451977679763387"
      "55035486650939145564820314822488831270237770396677079765598573333570"
      "13727342079099064400455741830654320379350833236245819348824064783585"
      "692924881021978332974949906122664421376034687815350484991",
      /* DR moduli */
      "14059105607947488696282932836518693308967803494693489478439861164411"
      "99243959839959474700214407465892859350284572975279726002583142341968"
      "6528151609940203368612079",
      "10174582569701926077392351975587856746131528201775982910760891436407"
      "52752352543956225804474009941755789631639189671820136396606697711084"
      "75957692810857098847138903161308502419410142185759152435680068435915"
      "159402496058513611411688900243039",
      "73633510803960459580592340614718453088992337057476877219196961242207"
      "30400993319449915739231125812675425079864519532271929704028930638504"
      "85730703075899286013451337291468249027691733891486704001513279827771"
      "74018362916106519487472796251714810077522836342108369176406547759082"
      "3919364012917984605619526140821797602431",
      "38564998830736521417281865696453025806593491967131023221754800625044"
      "11826546885121070536038571753679461518026049420807660579867166071933"
      "31995138078062523944232834134301060035963325132466829039948295286901"
      "98205120921557533726473585751382193953592127439965050261476810842071"
      "57368450587885458870662348457392592590350574754547108886771218500413"
      "52012892734056144158994382765356263460989042410208779740029161680999"
      "51885406379295536200413493190419727789712076165162175783",
      "54218939133169617266167044061918053674999416641599333415160174539219"
      "34845902966009796023786766248081296137779934662422030250545736925626"
      "89251250471628358318743978285860720148446448885701001277560572526947"
      "61939255157449083928645845499448866574499182283776991809511712954641"
      "41244487770339412235658314203908468644295047744779491537946899487476"
      "80362212954278693335653935890352619041936727463717926744868338358149"
      "56836864340303776864961677852601361049369618605589931826833943267154"
      "13281957242613296066998310166663594408748431030206661065682224010477"
      "20269951530296879490444224546654729111504346660859907296364097126834"
      "834235287147",
      "14872591348147092640920326485259710388958656451489011805853404549855"
      "24155135260217788758027400478312256339496385275012465661575576202252"
      "06314569873207988029466422057976484876770407676185319721656326266004"
      "66027039730507982182461708359620055985616697068444694474354610925422"
      "65792444947706769615695252256130901271870341005768912974433684521436"
      "21126335809752272646208391793909176002665892575707673348417320292714"
      "14414925737999142402226287954056239531091315945236233530448983394814"
      "94120112723445689647986475279242446083151413667587008191682564376412"
      "34796414611389856588668313940700594138366932599747507691048808666325"
      "63356891811579575714450674901879395531659037735542902605310091218790"
      "44170766615232300936675369451260747671432073394867530820527479172464"
      "10644245072764022650374658634027981631882139521072626829153564850619"
      "07146160831634031899433344310568760382865303657571873671474460048559"
      "12033137386225053275419626102417236133948503",
      "10951211157166778028568112903923951285881685924091094949001780089679"
      "55253005183831872715423151551999734857184538199864469605657805519106"
      "71752965504405483319768745978263629725521974299473675154181526972794"
      "07518606702687749033402960400061140139713092570283328496790968248002"
      "50742691718610670812374272414086863715763724622797509437062518082383"
      "05605014462496277630214789052124947706021514827516368830127584715531"
      "60422794055576326393660668474428614221648326558746558242215778499288"
      "63023018366835675399949740429332468186340518172487073360822220449055"
      "34058256846156864525995487330361695377639385317484513208112197632746"
      "27403549307444874296172025850155107442985301015477068215901887335158"
      "80733527449780963163909830077616357506845523215289297624086914545378"
      "51108253422962011656326016849452390656670941816601111275452976618355"
      "45793212249409511773940884655967126200762400673705890369240247283750"
      "76210477267488679008016579588696191194060127319035195370137160936882"
      "40224439969917201783514453748848639690614421772002899286394128821718"
      "53539149915834004216827510006035966557909908155251261543943446413363"
      "97793791497068253936771017031980867706707490224041075826337383538651"
      "82549367950377193483609465580277633166426163174014828176348776585274"
      "6577808019633679", /* generic unrestricted moduli */
      "17933601194860113372237070562165128350027320072176844226673287945873"
      "37075124543958779237196061507385566927408780505550797732302488688098"
      "5062002853331424203",
      "28935277207096612394938965623395440886203757364904084680118830304699"
      "39904368086092336458298221245707898933583190713188177399401852627749"
      "21099459597479178279025394653904396221302707492255957231214118178743"
      "4278708783207966459019479487",
      "34774315943987662607925279679742222317753544738820660760718166390304"
      "59075912019404782236217221181732708984875829871377086564143446858161"
      "79420855160986340457973820182883508387588163122354089264395604796675"
      "27896611756729481271481279682059656487645071606628312672001085904148"
      "4786529056457896367683122960411136319",
      "47266428956356393164697365098120418976400602706072312735924071745438"
      "53221823797933335177490730816834069332668731744372119326621515573581"
      "45107921487685764984911991227443513994894535335532038333186916782632"
      "41941706256996197460424029012419012634671862283532342656309677173602"
      "50949841797609150915436003989316503763703473702032739991040988579818"
      "57710035053205839677372934159799173173389858373857347474783642420203"
      "80416892056650841470869294527543597349250299539682430605173321029026"
      "55554683247304860032703684578197028928889831788842751736494531670908"
      "11738401861507943974790450340082577934368176833923752746357948352456"
      "95887",
      "43646380850595776857489487039434973962334644060194596116125444007214"
      "32981520401056764910482481101462787528578399305157661674414070215012"
      "29924721335644557342265864606569000117714935185566842453630868849121"
      "48017969183839954564436557110675773131737175855799078188069133669558"
      "47993133136872874688941488237617855829825495861837568064490175426222"
      "67874275103877481475534991201849912222670102069951687572917937634467"
      "77804287431546323806200920299208762096377175966644826653285807940266"
      "99200252242206134194410697184828373996126449788399252071098708402781"
      "94042158748845445131729137117098529028886770063736487420613144045836"
      "80398563565419248239588260351195054782643909283280053215253400393692"
      "60176124466061356551464456206233957889787267447285030586700468858762"
      "51527122350275750995227",
      "11424167473351836398078306042624362277956429440521137061889702611766"
      "34876069220624314041341107739458318072686327701201660227929014412678"
      "51295694749091735847898223419867427192303319460727303195559844849117"
      "16797058875905400999504305877245849119687509023232790273637466821052"
      "57685923245298206183100977078603178566903027154228660395611875558568"
      "39961188962152134888752531018946634030696777459483058938495054342017"
      "63745232895780711972432011344857521691017896316861403206449421332243"
      "65885545343578400651720289418164056243357539082138421096011751865037"
      "46022566010913796440342443322850659354132335579983315627491402029658"
      "44219336298970011513882564935538704289446968322281451907487362046511"
      "46122132979989735099337056069750580968643878203623537213701573130477"
      "90724302609864602698945221591030082604955030052671659275429494395262"
      "72736586626709581721032189532726389643625590680105784844246152702670"
      "169304203783072275089194754889511973916207",
      "12148556368165626375025840601634038302707050006347134830151013848818"
      "71978446801224798536155406895823305035467591632531067547890948695117"
      "17207695422072707568804875102242119871203284889005635784597424656074"
      "83479186300508539336977922549558904397202975606935794002970623969043"
      "06270145886830719309296352765295712183040773146419022875165382778007"
      "04010995760973958987559088570112619790606362013395489321661267883850"
      "75407771384377977056024537195590176339864866495236119758650057123711"
      "94067612263330335590526176087004421363598470302731349138773205901447"
      "70468218151790406473563651846245224279167654172529237892556829685801"
      "01518523263167775119350375310174139105069219224506669332022784890245"
      "21263798482237150056835746454842662048692127173834433089016107854491"
      "09745672501632770966319973823844216484314713278915372551325716791555"
      "51620949708535844479931254886076960081698073747367112970074738122562"
      "72245489405898470297178738029484459690836250560495461579533254473316"
      "34060821787678198618870592827073569575283082552796383835541976251624"
      "60286802809880204019145518254873499903069763040931093844514388132512"
      "11051597392127491464898797406789175453067960072008590614886532333015"
      "88117136710444504471814431241681571221661157622154645596877080141344"
      "0778423979", NULL};
    log = FOPEN("logs/expt.log", "w");
    logb = FOPEN("logs/expt_dr.log", "w");
    logc = FOPEN("logs/expt_2k.log", "w");
    logd = FOPEN("logs/expt_2kl.log", "w");
    for (n=0; primes[n]; ++n) {
      SLEEP;
      mp_read_radix(&a, primes[n], 10);
      mp_zero(&b);
      for (rr=0; rr<(unsigned)mp_count_bits(&a); ++rr) {
        mp_mul_2(&b, &b);
        b.dp[0] |= lbit();
        b.used += 1;
      }
      mp_sub_d(&a, 1, &c);
      mp_mod(&b, &c, &b);
      mp_set(&c, 3);
      rr = 0;
      tt = -1;
      do {
        gg = TIMFUNC();
        DO(mp_exptmod(&c, &b, &a, &d));
        gg = (TIMFUNC()-gg) >> 1;
        if (tt > gg)
          tt = gg;
      } while (++rr < 10);
      mp_sub_d(&a, 1, &e);
      mp_sub(&e, &b, &b);
      mp_exptmod(&c, &b, &a, &e); /* c^(p-1-b) mod a */
      mp_mulmod(&e, &d, &a, &d);  /* c^b * c^(p-1-b) == c^p-1 == 1 */
      if (mp_cmp_d(&d, 1)) {
        printf("Different (%d)!!!\n", mp_count_bits(&a));
        draw(&d);
        exit(0);
      }
      printf("Exponentiating\t%4d-bit => %9llu/sec, %9llu cycles\n",
             mp_count_bits(&a), CLK_PER_SEC/tt, tt);
      FPRINTF(n<4 ? logd : (n<9) ? logc : (n<16) ? logb : log,
              "%d %9llu\n", mp_count_bits(&a), tt);
    }
  }
  FCLOSE(log);
  FCLOSE(logb);
  FCLOSE(logc);
  FCLOSE(logd);

  log = FOPEN("logs/invmod.log", "w");
  for (cnt=4; cnt<=32; cnt+=4) {
    SLEEP;
    mp_rand(&a, cnt);
    mp_rand(&b, cnt);
    do {
      mp_add_d(&b, 1, &b);
      mp_gcd(&a, &b, &c);
    } while (mp_cmp_d(&c, 1) != MP_EQ);
    rr = 0;
    tt = -1;
    do {
      gg = TIMFUNC();
      DO(mp_invmod(&b, &a, &c));
      gg = (TIMFUNC()-gg) >> 1;
      if (tt > gg)
        tt = gg;
    } while (++rr < 1000);
    mp_mulmod(&b, &c, &a, &d);
    if (mp_cmp_d(&d, 1) != MP_EQ) {
      printf("Failed to invert\n");
      return 0;
    }
    printf("Inverting mod\t%4d-bit => %9llu/sec, %9llu cycles\n",
           mp_count_bits(&a), CLK_PER_SEC/tt, tt);
    FPRINTF(log, "%d %9llu\n", cnt*DIGIT_BIT, tt);
  }
  FCLOSE(log);
  return 0;
}

