/* A simple static test program. */
#include "rn.h"

#ifdef GBA_MODE
#include <gba.h>
#define DISPLAY(x) modetxt_puts(vfb, x, 1)
#endif

#ifndef DISPLAY
#define DISPLAY(x) printf(x)
#define DISPLAY_P(...) printf(__VA_ARGS__)
#else
#define DISPLAY_P(...) (void)0
#define rn_dump(n, p)                                                      \
  do {                                                                     \
  } while (0)
#endif

#ifndef rn_dump
void rn_dump(const char *n, rni *p)
{
  int sz;
  if (rn_radix_siz(p, 2, &sz) != OK)
    return;
  char *str = malloc(sz);
  if (!str)
    return;
#ifdef STEST_VERBOSE
  rn_toradix(p, str, 2);
  DISPLAY_P("%s = 0b%s\n", n, str);
  rn_toradix(p, str, 16);
  DISPLAY_P("%s = 0x%s\n", n, str);
#endif
  rn_toradix(p, str, 10);
  DISPLAY_P("%s = %s\n", n, str);
  free(str);
}
#endif

#ifdef GBA_MODE
int c_main(void)
#else
int main(void)
#endif
{
  rni a, b, c, d, e, f;
  rnd dp;

  init(&a);
  init(&b);
  init(&c);
  init(&d);
  init(&e);
  init(&f);
#ifdef GBA_MODE
  install_common();
  modetxt_init();
  modetxt_gotoxy(0, 0);
#endif
  DISPLAY_P("TFM Ident string:\n%s\n\n", rn_ident());

  /* test multiplication */
  rn_read_radix(&a, "3453534534535345345341230891273", 10);
  rn_read_radix(&b, "2394873294871238934718923", 10);
  rn_read_radix(
    &c, "8270777629674273015508507050766235312931312159028658979", 10);
  rn_mul(&a, &b, &d);
  if (rn_cmp(&c, &d)) {
    DISPLAY("mul failed\n");
    return -1;
  } else {
    DISPLAY("mul passed\n");
  }

  /* test multiplication */
  rn_read_radix(&a, "304812903204982359873497123085236523786439125634782329"
                    "077823612378642782072357823645782648912747892642786342"
                    "89739",
                10);
  rn_read_radix(&b, "487614781263872637826382763278362876328362783628376278"
                    "38736278362923698724823749238732",
                10);
  rn_read_radix(&c, "148631277122703456330795063449073798556399345970094111"
                    "566425727579536662379559013612057910011823358035711507"
                    "406881550725771590629510553610792175417781097686367930"
                    "0283932188006885811950341132768970948",
                10);
  rn_mul(&a, &b, &d);
  if (rn_cmp(&c, &d)) {
    DISPLAY("mul failed\n");
    return -1;
  } else {
    DISPLAY("mul passed\n");
  }

  /* test multiplication */
  rn_read_radix(&a, "115792089237316195423570985008687907853269984665640564"
                    "039457584007913129639935",
                10);
  rn_read_radix(&b, "174224571863520493293247799005065324265471", 10);
  rn_read_radix(&c, "201738271725539733566868685312735302682007107143890713"
                    "777941026519888008590985443384875751614437441027099805"
                    "52583184385",
                10);
  rn_mul(&a, &b, &d);
  if (rn_cmp(&c, &d)) {
    DISPLAY("mul failed\n");
    return -1;
  } else {
    DISPLAY("mul passed\n");
  }

  /* test squaring */
  rn_read_radix(
    &a,
    "298723982748923478923473927489237289347238947238947238947238972893",
    10);
  rn_read_radix(&b, "892360178693791322355127870683675465213096894122626244"
                    "349643139941274116825428551906677242269206961639626448"
                    "36740110835385588789449",
                10);
  rn_sqr(&a, &c);
  if (rn_cmp(&c, &b)) {
    DISPLAY("sqr failed\n");
    return -1;
  } else {
    DISPLAY("sqr passed\n");
  }

  rn_read_radix(&a, "397823894238973128942895123894327123941724927848927349"
                    "274897238978927593487012378490184789429812734982738972"
                    "389",
                10);
  rn_read_radix(&b, "158263850827461677491961439999264901067636282938352531"
                    "932899298293270945997930087353471903166601507321298827"
                    "087008336951419604640736464667188494668962822678461626"
                    "245753696845719301945679092882499787869509090904187704"
                    "367321",
                10);
  rn_sqr(&a, &c);
  if (rn_cmp(&c, &b)) {
    DISPLAY("sqr failed\n");
    return -1;
  } else {
    DISPLAY("sqr passed\n");
  }

  rn_read_radix(&a, "134078079299425970995740249982058461274793658205923933"
                    "777235614437217640300735469768018742981669034276900318"
                    "58186486050853753882811946569946433649006084095",
                10);
  rn_read_radix(&b, "179769313486231590772930519078902473361797697894230657"
                    "273430081157732675805500963132708477322407536021120113"
                    "879871393357658789768814416622492847430639474097562152"
                    "033539671286128252223189553839160721441767298250321715"
                    "263238814402734379959506792230903356495130620869925267"
                    "845538430714092411695463462326211969025",
                10);
  rn_sqr(&a, &c);
  if (rn_cmp(&c, &b)) {
    DISPLAY("sqr failed\n");
    return -1;
  } else {
    DISPLAY("sqr passed\n");
  }

  /* montgomery reductions */
  rn_read_radix(&a, "234892374892374893489123428937892781237863278637826327"
                    "367637836278362783627836783678363",
                10);
  rn_read_radix(&b, "444782349274982374923412348927398739398328931938276275"
                    "6425425425642727352327452374521",
                10);
#ifdef FP_64BIT
  rn_read_radix(&c, "942974496560863503657226741422301598807235487941674147"
                    "660989764036913926327577165648",
                10);
#else
  rn_read_radix(&c, "239627188299073269808331703560583652369727778655605377"
                    "1759862552557086442129695099100",
                10);
#endif
  if (rn_mont_setup(&b, &dp) != OK)
    DISPLAY("mont setup failed\n");
  rn_mont_reduce(&a, &b, dp);
  if (rn_cmp(&a, &c)) {
    DISPLAY("mont failed\n");
    rn_dump("a (is    )", &a);
    rn_dump("c (should)", &c);
    return -1;
  } else {
    DISPLAY("mont passed\n");
  }

  rn_read_radix(&a, "234892374892374893489123445664565464564568457635342893"
                    "789278123786327863782632736763783627836278362783678367"
                    "8363",
                10);
  rn_read_radix(&b, "444782349274982374923412348927398739398328931938276275"
                    "64254254256427273523274523745212342432432444412111111"
                    "9",
                10);
  rn_read_radix(&c, "456426138445545829086526030861802674038233123909900823"
                    "28515008314514368668691233331246183943400359349283420",
                10);
  if (rn_mont_setup(&b, &dp) != OK)
    DISPLAY("mont setup failed\n");
  rn_mont_reduce(&a, &b, dp);
  if (rn_cmp(&a, &c)) {
    DISPLAY("mont failed\n");
    rn_dump("a (is    )", &a);
    rn_dump("c (should)", &c);
    return -1;
  } else {
    DISPLAY("mont passed\n");
  }

  rn_read_radix(&a, "234823424242342923748923748934891234456645654645645684"
                    "576353424972378234762378623891236834132352375235378462"
                    "378489378927812378632786378263273676378362783627555555"
                    "555539568389052478124618461834763837685723645827529034"
                    "853490580134568947341278498542893481762349723907847892"
                    "983627836783678363",
                10);
  rn_read_radix(&b, "444782349274565634559823749234123489273987393983289319"
                    "382762756424856234816382790254658912763129032628375623"
                    "490562347836487123146781203891738901289054252424242397"
                    "84256427",
                10);
  rn_read_radix(&c, "331608652654533616505640314645190421261856323334627540"
                    "844899857196134807832823574105148988197977380346004845"
                    "194726561523517771866946092182022765092710614602654883"
                    "48645081",
                10);
  if (rn_mont_setup(&b, &dp) != OK)
    DISPLAY("mont setup failed\n");
  rn_mont_reduce(&a, &b, dp);
  if (rn_cmp(&a, &c)) {
    DISPLAY("mont failed\n");
    rn_dump("a (is    )", &a);
    rn_dump("c (should)", &c);
    return -1;
  } else {
    DISPLAY("mont passed\n");
  }
  return 0;
}
